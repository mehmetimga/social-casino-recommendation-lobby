version: '3.8'

services:
  # PostgreSQL Database (for Go services)
  postgres:
    image: postgres:16-alpine
    container_name: casino-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-casino}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-casino_secret}
      POSTGRES_DB: ${POSTGRES_DB:-casino_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/migrations:/docker-entrypoint-initdb.d
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U casino -d casino_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - casino-network

  # MongoDB for PayloadCMS
  mongodb:
    image: mongo:7
    container_name: casino-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-admin_secret}
    volumes:
      - mongodb_data:/data/db
    ports:
      - "27017:27017"
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - casino-network

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: casino-qdrant
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "6333:6333"
      - "6334:6334"
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    networks:
      - casino-network

  # Ollama Local LLM (Disabled - using host machine Ollama for better performance)
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: casino-ollama
  #   volumes:
  #     - ollama_data:/root/.ollama
  #   ports:
  #     - "11434:11434"
  #   networks:
  #     - casino-network

  # PayloadCMS
  cms:
    build:
      context: ./cms
      dockerfile: Dockerfile
    container_name: casino-cms
    environment:
      DATABASE_URL: mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-admin_secret}@mongodb:27017/casino_cms?authSource=admin
      PAYLOAD_SECRET: ${PAYLOAD_SECRET:-your-payload-secret-key-change-in-production}
      NEXT_PUBLIC_SERVER_URL: ${PAYLOAD_PUBLIC_SERVER_URL:-http://localhost:3001}
      PORT: 3001
    volumes:
      - cms_media:/app/media
      - ./casino-images:/casino-images:ro
      - ./casino-banners:/casino-banners:ro
    ports:
      - "3001:3001"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - casino-network

  # Recommendation Service (Go)
  recommendation:
    build:
      context: ./services/recommendation
      dockerfile: Dockerfile
    container_name: casino-recommendation
    environment:
      PORT: 8081
      POSTGRES_URL: postgres://${POSTGRES_USER:-casino}:${POSTGRES_PASSWORD:-casino_secret}@postgres:5432/${POSTGRES_DB:-casino_db}?sslmode=disable
      QDRANT_URL: http://qdrant:6333
      OLLAMA_URL: http://host.docker.internal:11434
      CMS_URL: http://cms:3001
      ML_URL: http://ml:8083
    ports:
      - "8081:8081"
    depends_on:
      - postgres
      - qdrant
      - cms
    networks:
      - casino-network

  # Chat + RAG Service (Go)
  chat:
    build:
      context: ./services/chat
      dockerfile: Dockerfile
    container_name: casino-chat
    environment:
      PORT: 8082
      POSTGRES_URL: postgres://${POSTGRES_USER:-casino}:${POSTGRES_PASSWORD:-casino_secret}@postgres:5432/${POSTGRES_DB:-casino_db}?sslmode=disable
      QDRANT_URL: http://qdrant:6333
      OLLAMA_URL: http://host.docker.internal:11434
    ports:
      - "8082:8082"
    depends_on:
      - postgres
      - qdrant
    networks:
      - casino-network

  # ML Service (Python - LightGCN/TGN/HGT)
  ml:
    build:
      context: ./services/ml
      dockerfile: Dockerfile
    container_name: casino-ml
    environment:
      ML_POSTGRES_HOST: postgres
      ML_POSTGRES_PORT: 5432
      ML_POSTGRES_USER: ${POSTGRES_USER:-casino}
      ML_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-casino_secret}
      ML_POSTGRES_DB: ${POSTGRES_DB:-casino_db}
      ML_QDRANT_HOST: qdrant
      ML_QDRANT_PORT: 6333
      ML_CMS_URL: http://cms:3001
      ML_DEBUG: ${ML_DEBUG:-false}
    volumes:
      - ml_models:/app/models
    ports:
      - "8083:8083"
    depends_on:
      - postgres
      - qdrant
    # For GPU support, use docker-compose.gpu.yml override
    networks:
      - casino-network

  # Frontend (Vite + React)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: casino-frontend
    environment:
      VITE_CMS_URL: ${VITE_CMS_URL:-http://localhost:3001}
      VITE_RECOMMENDATION_URL: ${VITE_RECOMMENDATION_URL:-http://localhost:8081}
      VITE_CHAT_URL: ${VITE_CHAT_URL:-http://localhost:8082}
      VITE_ML_URL: ${VITE_ML_URL:-http://localhost:8083}
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    depends_on:
      - cms
    networks:
      - casino-network

networks:
  casino-network:
    driver: bridge

volumes:
  postgres_data:
  mongodb_data:
  qdrant_data:
  ollama_data:
  cms_media:
  ml_models:
